language: java

# -------------  ALL BRANCHES FIRE MVN INSTALL  ------------- ------------- --------
# DEVELOP: BUILD ON COMMIT (NO DEPLOY)
# MASTER: BUILD ON COMMIT (NO DEPLOY)
# +++++++++++++  STABLE AND TAGS FIRE DEPLOY    ++++++++++++++++++++++++++++++++++++
# STABLE: BUILD ON COMMIT + DEPLOY SNAPSHOT RELEASE
# TAGS: BUILD ON COMMIT + DEPLOY SONATYPE VERSION  RELEASE
# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Be aware when adding 'branch.only' they can exclude tags deployment is not fired
# -------------------------- ------------- ------------- ------------- ------------- 


matrix:
  include:
    - os: linux
      dist: xenial
      jdk: openjdk11
            
services:
  - docker    

before_install:
    - export GPG_TTY=/dev/pts/4
    - echo $GPG_SECRET_KEYS | base64 --decode | $GPG_EXECUTABLE --import
    - echo $GPG_OWNERTRUST | base64 --decode | $GPG_EXECUTABLE --import-ownertrust
    - docker version
    - docker info
    - export project_version=1.0.0
    - echo $project_version


install:
    docker build -f Dockerfile -t jsoagger/jsoagger-web:$project_version .      

deploy: 
    - provider: script
      script: 
        - docker push jsoagger/jsoagger-webdev:$project_version
        - docker build  -f Dockerfile-prod -t jsoagger/jsoagger-web:$project_version .
      on:
        branch: master

    - provider: script
      script: 
        - docker build  -f Dockerfile-prod -t jsoagger/jsoagger-web:$project_version .
        - docker push jsoagger/jsoagger-web:$project_version
      on:
        tags: true
        all_branches: true
         
        
